define("text!views/iboxleft/left.css",[],function(){return"#iboxlist .op1{margin-top:10px;}#sharetome{margin-left:20px;font-size:15px;line-height:40px;cursor:pointer;}#sharetome:hover{color:#63a2ef;}.treepop:after{left:20px;}#treeleft .jstree-anchor{width:130px;}#treeleft .jstree-input{width:83px;}#treeleft .jstree-item > .jstree-witem > .share{background-position:-120px 8px;display:inline-block !important;}#treeleft .jstree-item > .jstree-witem > .share:hover,#tree .jstree-item > .jstree-item-on > .share,#treeleft .jstree-item-active > .jstree-witem .share{background-position:-120px -20px !important;}#treeleft .jstree-item > .jstree-witem > .person{background-position:-154px 8px;}#treeleft .jstree-item > .jstree-witem > .person:hover,#tree .jstree-item > .jstree-item-on > .person ,#treeleft .jstree-item-active > .jstree-witem .person{background-position:-154px -20px !important;}#treeleft .jstree-item-on > .jstree-wname .jstree-anchor{color:inherit;}#treeleft .jstree-item-on > .jstree-wname .jstree-anchor:hover{color:#63a2ef;}#treeleft .jstree-item-active > .jstree-witem .jstree-anchor{color:#63a2ef;}#tree .jstree-item > .jstree-item-on > .jstree-icon,#tree .jstree-item-active.jstree-item > .jstree-witem .jstree-icon{background-position:-60px -23px;}#tree .jstree-close > .jstree-item-on > .jstree-icon,#tree .jstree-item-active.jstree-close > .jstree-witem .jstree-icon{background-position:1px -23px;}#tree .jstree-open > .jstree-item-on > .jstree-icon,#tree .jstree-item-active.jstree-open > .jstree-witem .jstree-icon{background-position:-30px -23px;}"}),define("views/iboxleft/iboxleft",["text!views/iboxleft/left.css"],function(e){var t=Backbone.BaseView.extend({el:"#treeleft",cssText:e,url:$.urlMap.turl,events:{"mouseenter .jstree-anchor":"evtDragenter","mouseleave .jstree-anchor":"evtDragout"},treeTpl:'<span class="jstree-whole"></span><div class="jstree-witem " ><i class="jstree-icon <%if(this.type=="2"&&this.fid=="-1"){%>share<%}else if(this.type=="2"){%>person<%}else{%>file<%}%>"></i><div class="jstree-wname" ><%if(!this.isInput){%><span class="jstree-anchor" data-menu="<%this.allowmenu?1:0%>"  <%if(!(this.text.length < 10)){%>data-tips="<%this.text%>" <%}%> data-fid="<%this.fid%>"  <%if(this.type=="1"&&this.depth!=1){%>draggable="true"<%}%> data-drop="<%if(this.type=="1"){%>1<%}%>"><%this.text%></span><%}else{%><input class="jstree-input"  type="text" value="<%this.text%>"/><span class="jstree-cancel"></span><%}%></div></div>',reloadTree:function(e){var t=this;if(!t.tree||t.options.route!="ibox")return;t.tree.updateTree({getData:this.getTreeData(e)})},getTreeData:function(e){var t=this;return function(e){return function(){var n=e||t.options.fid,r=$.Deferred();return $.get($.urlMap.turl,{source:"person",vfid:n,_:(new Date).getTime()},function(e){if(parseInt(e.errno))return;r.resolve(e.result)}),r.promise()}}(e)},init:function(e){var t=this;Backbone.Events.on("UpdateTree",function(e){t.reloadTree(e)}),Backbone.Events.on("UpdateCur",function(e){t.setDomAsCurrent(e)}),Backbone.Events.on("dragfile",function(e){t.dragFromOut=1,t.outDragFid=e}),Backbone.Events.on("dragfileend",function(){t.dragFromOut=0}),$("body").on("mouseup",function(e){t.evtDrop(e)}),this.$el.on("mousewheel",function(e){$(".jstree-menu").hide()}),this.extendInit.call(this,e),$.fn.poptips({parent:"body",selector:".jstree-anchor",top:10,left:10,cls:"treepop",width:"auto"})},extendInit:function(){},setDomAsCurrent:function(e){var t,n,r;e=e!=undefined?e:this.fid,e=e=="share"?"-1":e,n=this.$el.find('[data-fid="'+e+'"]');if(!n.length)return;r=$.ldom.getParentByTag(n[0],"li"),t=$(r).offset().top,this.$el.find(".jstree-item-active").removeClass("jstree-item-active"),this.$el[0].scrollTop=t-100,this.tree.$activeItem=$(r),$(r).addClass("jstree-item-active"),this.$el.find(".wrap-tree").css({opacity:1})},getMenuConfig:function(){var e=this,t={insertBefore:1,dbclicktime:200,dropParent:"#wrapall",reqOnAdd:function(e,t){var n=$.Deferred(),r;return r=$.urlMap.addurl,$.post(r,{dirname:t,source:"person",parentid:e,sid:0},function(e){n.resolve(e)}),n.promise()},reqOnRemove:function(e){var t=$.Deferred(),n;return n=$.urlMap.removeurl,$.post(n,{fids:e},function(e){t.resolve()}),t.promise()},reqOnRename:function(e,t){var n=$.Deferred(),r;return r=$.urlMap.seturl,$.post(r,{fid:e,name:t},function(e){n.resolve(e)}),n.promise()}};return t},initTree:function(){var e=this,t,n;n=this.getMenuConfig(),t=this.fid;if(this.hasInit)return;this.hasInit=1,this.tree=$.BaseTree2.getExample({parentId:"tree",getData:function(e){e==0&&(e=t);var n=$.Deferred();return $.get($.urlMap.turl,{source:"person",vfid:e,_:(new Date).getTime()},function(e){if(parseInt(e.errno))return;n.resolve(e.result)}),n.promise()},getCData:function(e){var t=$.Deferred();return e=e||0,$.get($.urlMap.turl,{source:"person",fid:e,_:(new Date).getTime()},function(e){if(parseInt(e.errno))return;t.resolve(e.result)}),t.promise()},litpl:e.treeTpl,alias:function(e){var t={id:"fid",text:"dirname",hasChild:"havechild",child:"child",allowmenu:"allowmenu"};return t[e]||e},open:!0,plugins:[{type:"menu2",options:n},{type:"dnd2",options:{insertBefore:1,reqOnMove:function(e,t){var n=$.Deferred(),r;return r=$.urlMap.moveurl,$.post(r,{dest_fid:t,source_fids:e},function(e){n.resolve()}),n.promise()}}}],callbacks:{onClick:function(t){var n=t.target.getAttribute("data-fid"),r={};r.fid=n;if(n==-2)return;n=="-1"&&(r.fid="share"),e.goIboxPage(r)},onBuildTree:function(){e.setDomAsCurrent()},onDuplicatNameOnRename:function(e){$.fn.tips("不能重名")},onDuplicatNameOnMove:function(e){$.fn.tips("移动失败,该目录下已经有同名文件夹")},onMoveToChildError:function(e){$.fn.tips("移动失败,不能移动到子节点")},onDeleteChild:function(t){var n=t.fid;e.goIboxPage({fid:n}),e.setDomAsCurrent(n),$.fn.tips("删除成功",1)}}})},display:function(e){var t=this,n=e.fid||0;this.fid=n,this.options=e;if(n==this.lastFid)return;this.lastFid=n,this.initTree()},evtDrop:function(e){e=e.originalEvent;var t=this.outDragFid,n=$(e.target),r,i;if(!this.dragFromOut||!t)return;if(!n.hasClass("jstree-anchor")){this.dragFromOut=0;return}r=e.target.getAttribute("data-fid"),i=e.target.getAttribute("data-menu")-0;var s=$(e.target).attr("data-drop")-0;if(!i&&!s)return;$.ajax({data:{dest_fid:r,source_fids:t},url:$.urlMap.moveurl,type:"get",dataType:"json",success:function(e){if(e.errno){$.fn.tips(e.errmsg);return}Backbone.Events.trigger("movesuccess",{did:r,fid:t}),$.fn.tips("移动成功",1)}}),this.dragFromOut=0},evtDragenter:function(e){var t,n,r;e=e.originalEvent;if(!this.dragFromOut)return;r=$(e.target);var i=$(e.target).attr("data-menu")-0,s=$(e.target).attr("data-drop")-0;if(!i&&!s){r.css("cursor","no-drop");return}t=$($.ldom.getParentByTag(e.target,"li")),$(e.target).addClass("dragenter"),this.tree.showFold(t)},evtDragout:function(e){var t=$(e.target);t.css("cursor","pointer"),e=e.originalEvent,$(e.target).removeClass("dragenter")}});return t}),define("text!views/teamleft/teamleft.css",[],function(){return"#wrapaddnew{width:300px;height:165px;}#wrapaddnew .nav{height:32px;line-height:32px;background-color:#e5e5e5;}#wrapaddnew input{border:1px solid #64a2ef;line-height:21px;height:21px;width:263px;display:block;margin:24px auto 0;padding-left:5px;}#wrapaddnew .op6{margin-top:36px;}#wrapaddnew .close{top:-5px;}#treeteam{margin-top:20px;}#treeteam .depth1 > .jstree-witem > .jstree-icon{background-position:-183px 6px;}#treeteam .headnav{display:none;}#treeteam .depth1 > .jstree-witem > .jstree-icon:hover{background-position:-183px -23px;}#treeteam .depth1.jstree-close > .jstree-witem > .jstree-icon{background-position:-213px 6px;}#treeteam .depth1.jstree-close > .jstree-witem > .jstree-icon:hover{background-position:-213px -23px;}#treeteam .depth1.jstree-open > .jstree-witem > .jstree-icon{background-position:-213px 6px;}#treeteam .depth1.jstree-open > .jstree-witem > .jstree-icon:hover{background-position:-213px -23px;}.jstree-menu{max-height:140px !important;}#setRuleModel{position:relative;height:430px;width:720px;}#setRuleModel .stopShare{cursor:pointer;}#setRuleModel .nav{height:31px;line-height:31px;background-color:#e5e5e5;font-size:15px;padding-left:15px;}#setRuleModel .top .greybox{margin-right:10px;}#setRuleModel .content{height:323px;border-bottom:1px solid #e5eaee;}#setRuleModel .left{width:95px;height:323px;overflow:hidden;border-right:1px solid #e5eaee;}#setRuleModel ul{margin-top:12px;}#setRuleModel .left li{height:43px;line-height:43px;cursor:pointer;}#setRuleModel .left li.cur{background-color:#e5e5e5;}#setRuleModel .right{position:absolute;left:115px;top:31px;right:17px;height:238px;}#setRuleModel .switch li{position:relative;}#setRuleModel .switch li > span{display:block;padding-left:45px;}#setRuleModel .switch span:after{content:'';width:20px;height:20px;display:block;position:absolute;left:23px;background:url(common/imgs/result.png) no-repeat -76px -974px;margin-top:-10px;top:50%;}#setRuleModel .switch li:hover span,#setRuleModel .switch li.cur span{color:#63a2ef;}#setRuleModel .switch li:hover span:after,#setRuleModel .switch li.cur span:after{background-position:-76px -1004px;}#setRuleModel .switch li.first span:after{background-position:-107px -974px;}#setRuleModel .switch li.first:hover span:after,#setRuleModel .switch li.first.cur span:after{background-position:-107px -1004px;}#setRuleModel .top{margin:20px 18px 20px 0;}#setRuleModel .close{background-position:-100px -457px;}#setRuleModel .search{width:302px;height:28px;line-height:28px;border:1px solid #63a2ef;margin:auto 14px;padding-left:9px;}#setRuleModel .bottom *{vertical-align:middle;}#setRuleModel .bottom{position:absolute;bottom:21px;left:17px;right:17px;line-height:30px;}#setRuleModel .grey{color:#9d9d9d;}#setRuleModel .greybox{margin-right:7px;cursor:pointer;}#setRuleModel .tips{color:#fa6430;padding-left:20px;position:relative;margin-left:16px;opacity:0;}#setRuleModel .tips:after{position:absolute;left:0;top:0;content:'';width:20px;height:20px;display:block;background:url(\"common/imgs/result.png\") -45px -975px no-repeat;}#setRuleModel .bottom span:first-child{color:#99adb8;margin-right:20px;}#setRuleModel table{border-collapse:collapse;width:100%;}#setRuleModel tr.on td,#setRuleModel .disable td{background-color:#f5f5f5;}.wraphead{border-left:1px solid #ddd;width:100%;box-sizing:border-box;border-right:1px solid #ddd;border-top:1px solid #ddd;background-color:#f5f5f5;overflow:hidden;}.wrapitems2 .wraptable{max-height:203px;overflow-x:hidden;overflow:auto;border:1px solid #ddd;border-bottom:none;position:relative;}.wraphead span{display:inline-block;line-height:33px;border-right:1px solid #ddd;text-align:center;}.wraphead span:last-child{border-right:0;min-width:75px;}.wraprule td:nth-child(2) div{width:108px;overflow:hidden;text-overflow:ellipsis;}.wraprule td:nth-child(2) div span{display:inline-block;width:21px;height:28px;vertical-align:top;background:url('common/imgs/result.png') no-repeat -90px -25px;cursor:pointer;position:relative;}.wraprule td:nth-child(1),.wraphead span:nth-child(1){width:50px;}.wraprule td:nth-child(3),.wraphead span:nth-child(3),.wraprule td:nth-child(4),.wraphead span:nth-child(4),.wraprule td:nth-child(5),.wraphead span:nth-child(5),.wraprule td:nth-child(6),.wraphead span:nth-child(6),.wraprule td:nth-child(7),.wraphead span:nth-child(7){width:48px;}.wraprule td:nth-child(2),.wraphead span:nth-child(2){width:186px;text-align:left;padding-left:28px;}.show-edit td:nth-child(2),.show-edit .wraphead span:nth-child(2){width:136px;}.show-edit td:nth-child(8),.show-edit .wraphead span:nth-child(8){width:48px;}.items2 .greybox{margin-right:0;}#setRuleModel th{background-color:#f5f5f5;border-bottom:1px solid #ddd;}.wraprule td,.wraprule th{border-right:1px solid #ddd;border-bottom:1px solid #ddd;text-align:center;}.wraprule td:last-child,.wraprule th:last-child{border-right:0px;}.wraprule th{line-height:33px;}.wraprule td{line-height:28px;padding:0;}#setRuleModel .bbutton{display:inline-block;vertical-align:top;height:30px;line-height:30px;margin-right:10px;}#setRuleModel #ok5{position:absolute;right:17px;margin-right:0;bottom:21px;}#okset{margin-left:20px;}.delrule{height:28px;width:30px;margin:0 auto;display:block;cursor:pointer;background:url(common/imgs/result.png) -67px -291px no-repeat;}.delrule:hover{background-position:-67px -331px;}.disable .delrule:hover{background-position:-67px -291px;}.rpart .delrule{background-position:-109px 4px;}.rpart .delrule:hover{background-position:-109px -26px;}.rpart .disable .delrule:hover{background-position:-109px 4px;}#setRuleModel .right > div{display:none;}#setRuleModel .right .rpart{display:block;}.addall{color:#63a2ef;cursor:pointer;}.treepop::after{left:14px;}.tips-relation{position:absolute;right:39px;top:7px;z-index:100;width:20px;height:20px;cursor:pointer;background:url('common/imgs/result.png') no-repeat -88px 1px;}.tips-relation div{display:none;position:absolute;width:230px;top:30px;right:-10px;min-height:25px;line-height:16px;padding:8px;border:1px solid #d5d5d5;background-color:#fff;box-shadow:0px 0px 1px 1px #e4e4e4;font-size:12px;color:#9d9d9d;z-index:1000000;text-align:left;}.tips-relation:hover div{display:block;}.tpop{width:auto;font-size:12px;}.tpop:after{display:none;}#setRuleModel .t1{}.t1-index{display:block;text-align:center;width:100%;height:100%;}.wbfc{overflow:hidden;}.addnew{margin-top:5px;}#treeleft2 .headnav{margin-bottom:10px;}#treeleft2 #treeteam{margin-top:20px;}"}),define("text!views/teamleft/setrule.tpl",[],function(){return'<div class="wraprule <%if(showEditLine){%>show-edit<%}%>">\n    <div class="nav">权限设置<%=name%></div>\n    <div class="tips-relation"> <div>"查看"为最小权限,被包含于其他所有权限中<br />"管理"为最大权限,包含其他所有权限</div></div>\n    <div class="close close4"></div>\n    <div class="content">\n        <div class="left">\n            <ul class="switch">\n                <li class="cur first" data-for="rpart"><span>部门</span></li>\n                <li data-for="ruser"><span>用户</span></li>\n            </ul>\n        </div>\n        <div class="right">\n            <div class="rpart">\n                <div class="top"><span>部门</span><input type="text" class="search spart"/><span class="bbutton"\n                                                                                                 id="startSearch">搜索</span>\n                </div>\n                <div class="wrapitems2">\n                    <div class="wraphead">\n                        <span>序号</span><span>部门</span><span>查看</span><span>上传</span><span>下载</span><%if(showEditLine){%><span>编辑</span><%}%><span>删除</span><span>管理</span><span>操作</span>\n                    </div>\n                    <div class="wraptable">\n                        <table class="items2">\n                        </table>\n                    </div>\n\n                </div>\n\n            </div>\n            <div class="ruser">\n                <div class="top"><span>用户</span><input type="text" class="search  suser" /><span class="bbutton"\n                                                                                                 id="auser">添加</span><span class="addall">添加所有人</span>\n                </div>\n                <div class="wrapitems2">\n                    <div class="wraphead">\n                        <span class="t1">序号</span><span class="t2">用户名</span><span class="t3">查看</span><span class="t3">上传</span><span class="t3">下载</span><%if(showEditLine){%><span>编辑</span><%}%><span class="t3">删除</span><span class="t3">管理</span><span class="t3">操作</span>\n                    </div>\n                    <div class="wraptable">\n                        <table class="items2">\n                        </table>\n                    </div>\n\n                </div>\n\n\n            </div>\n\n\n        </div>\n    </div>\n    <div class="bottom">\n        <input type="checkbox" class="inherit greybox"/><span class="grey">继承父级权限</span><span class="tips">您更改的权限将丢失,恢复到与父目录一致</span>\n    </div>\n    <span class="bbutton" id="ok5">确认</span>\n</div>\n'}),define("text!views/teamleft/newspace.tpl",[],function(){return'<div class="nav"><span class="tit">新建空间</span><span class="close close4"></span></div> <input type="text" id="spacename" value=""> <div class="op6"><div id="ok4" class="bbutton">确认</div><div class="close3 close4">取消</div></div>'}),define("text!views/teamleft/treespan.tpl",[],function(){return'<span class="jstree-whole"></span>\n<div class="jstree-witem <%if(this.islock){%>locked<%}%>" >\n <i class="jstree-icon <%if(this.type=="2"&&this.fid=="-1"){%>share<%}else if(this.type=="2"){%>person<%}else{%>file<%}%>"></i>\n<div class="jstree-wname" >\n <%if(!this.isInput){%>\n <span class="jstree-anchor" data-menu="<%this.allowmenu?1:0%>"  <%if(!(this.text.length < 15)){%>data-tips="S" <%}%> data-fid="<%this.fid%>"  <%if(this.type=="1"&&this.depth!=1){%>draggable="true"<%}%> data-drop="<%if(this.type=="1"){%>1<%}%>"><%this.text%></span>\n <%}else{%>\n <input class="jstree-input"  type="text" value="<%this.text%>"/><span class="jstree-cancel"></span>\n <%}%>\n\n </div>\n</div>'}),define("text!views/teamleft/tabletr.tpl",[],function(){return'<%for(var i =0,l=datas.length;i<l;i++){var data=datas[i]%>\n<tr class="<%if(data.isrewrite!=\'1\'){%> disable<%}%>" data-email="<%=data.email%>" data-isqadmin="<%=data.isqadmin%>"  data-name="<%if(data.rtype=="1"){%><%=data.realname%><%}else{%><%=data.name%><%}%>" data-rtype="<%=data.rtype%>" data-isrewrite="<%=data.isrewrite%>"  >\n<td class="t1"><span class="t1-index"><%=(start+i)%></span></td>\n<td class="t2"><div><%if(data.isqadmin){%><span class="ttip" data-tips="空间管理员"></span><%}%><%if(data.rtype=="1"){%><%=data.realname%><%}else{%><%=data.name%><%}%></div></td>\n<td><input class="greybox"  value="isview" type="checkbox" <%if(data.isview){%>checked<%}%> name="" <%if(data.isrewrite!=\'1\'){%> disabled="disabled"<%}%>/></td>\n\n<td><input class="greybox"  value="isupload" type="checkbox" <%if(data.isupload){%>checked<%}%> name="" <%if(data.isrewrite!=\'1\'){%> disabled="disabled"<%}%>/></td>\n<td><input class="greybox"  value="isdownload" type="checkbox" <%if(data.isdownload){%>checked<%}%> name="" <%if(data.isrewrite!=\'1\'){%> disabled="disabled"<%}%> /></td>\n<%if(showEditLine){%><td><input class="greybox"  value="isedit" type="checkbox" <%if(data.isedit){%>checked<%}%> name="" <%if(data.isrewrite!=\'1\'){%> disabled="disabled"<%}%>/></td><%}%>\n\n<td><input class="greybox"  value="isdel" type="checkbox" <%if(data.isdel){%>checked<%}%> name="" <%if(data.isrewrite!=\'1\'){%> disabled="disabled"<%}%>/></td>\n<td><input class="greybox"  value="isadmin" type="checkbox" <%if(data.isadmin){%>checked<%}%> name="" <%if(data.isrewrite!=\'1\'){%> disabled="disabled"<%}%>/></td>\n<td><span class="delrule ttip"  data-tips="<%if(data.rtype=="1"){%>删除<%}else{%>清除<%}%>" ></span></td>\n</tr><%}%>'}),define("views/teamleft/teamleft",["views/iboxleft/iboxleft","text!views/teamleft/teamleft.css","text!views/teamleft/setrule.tpl","text!views/teamleft/newspace.tpl","text!views/teamleft/treespan.tpl","text!views/teamleft/tabletr.tpl"],function(e,t,n,r,i,s){var o=e.prototype.events,u=e.extend({el:"#treeleft2",cssText:t,url:$.urlMap.tturl,newtpl:_.template(r),settpl:_.template(n),ruletd:_.template(s),treespantpl:i,dataAuthorTag:{},dataAuthor:[],hideTime:2e3,ruleParent:"#setRuleModel",events:$.extend({"click .addnew":"showAddNew"},o),showAddNew:function(){this.modal.addNew.show()},rightOps:{download:{name:"下载",value:"down"},addfolder:{name:"新建子目录",value:"create"},del:{name:"删除",value:"delete"},rename:{name:"重命名",value:"rename"},setrule:{name:"权限设置",value:"setrule"}},switchTypes:function(e){var t=$(e.currentTarget),n,r,i;i=t.attr("data-for"),this.currentRuleType=i=="rpart"?3:1,n=t.parents("ul"),n.find("li").removeClass("cur"),t.addClass("cur"),r=n.parents(".wraprule"),r.find(".right>div").hide(),r.find("."+i).show()},showTeams:function(e,t){var n=this,r=n.kfid,i={fid:r,type:3,_:(new Date).getTime()};t&&(i.isherit=1),$.get($.urlMap.teamrules,i,function(e){if(e.errno)return;n.renderTeams(e.result.rules)})},renderTeams:function(e){var t=$(this.ruleParent),n=this;n.dataTeam=e;var r=n.ruletd({datas:e,start:1,isSpace:/^\d+$/.test(n.kfid)?0:1,showEditLine:n.showEditLine});t.find(".rpart .items2").html(r)},showUsers:function(e,t){var n=this,r=n.kfid,i={fid:r,type:1,_:(new Date).getTime()};t&&(i.isherit=1),$.get($.urlMap.teamrules,i,function(e){if(e.errno)return;t||($(n.ruleParent).find(".inherit").prop("checked",e.result.isherit=="1"),e.result.isherit||n.showTips("目录权限已修改，不再与父目录一致")),n.renderUsers(e.result.rules)})},renderUsers:function(e){var t=this,n=$(this.ruleParent),r=t.ruletd({datas:e,start:1,isSpace:/^\d+$/.test(t.kfid)?0:1,showEditLine:t.showEditLine}),i=_.pluck(e,"email");$.each(i,function(n){t.dataAuthorTag[i[n]]=1,t.dataAuthor.push(e[n])}),t.selectUserLength=e.length,n.find(".ruser .items2").html(r)},initUsers:function(e){this.selectUserLength=0,e.find("table").html(""),e.find(".search").val("")},initUserSearch:function(){var e=this;if(this.hasInitDropSearch)return;this.hasInitDropSearch=1,$.InputDropDown.getExample({el:".suser",parent:"body",css:{width:311,height:150,maxHeight:150},leftOffset:0,topOffset:3,tpl:'<%for(var i=0;i<this.lists.length;i++){ list=this.lists[i];%><li class="linfo <%if(list.hasShow){%>added<%}%>" data-value="<%list.key%>"  data-realname="<%list.truename%>" data-rtype="<%list.type%>" ><%list.truename%>(<%list.departmentName%>)<div><%list.key%></div></li><%}%>',getData:function(e){var t=this,n=$(e.target),r,i=$.Deferred();return r=n.val(),$.ajax({url:$.urlMap.searchUser,cache:!1,type:"get",dataType:"json",data:{kw:r},success:function(e){e=e.result,t.lists=e,i.resolve()}}),i.promise()},tplSpan:'<span class="op5"><%=name%></span>',delCallback:function(e){},enterCallback:function(e){},selectCallback:function(t){var n=t.attr("data-value"),r,i,s=t.attr("data-rtype"),o=t.attr("data-realname");e.addUser({email:n,rtype:s,isview:1,isdownload:0,isedit:0,isadmin:0,isrewrite:1,isqadmin:0,realname:o},1),this.$el.val(""),this.hide(),e.noInherit()}})},noInherit:function(){var e=this;$(e.ruleParent).find(".inherit").prop("checked",!1),e.showTips("目录权限已修改，不再与父目录一致")},addUser:function(e,t){var n=this,r,i,s;s=$(n.ruleParent+" .ruser  table");if(n.dataAuthorTag[e.email]){$.fn.tips("已添加该人!");return}n.dataAuthorTag[e.email]=1,n.selectUserLength==undefined&&(n.selectUserLength=0),++n.selectUserLength,i=n.selectUserLength,r=n.ruletd({datas:[e],start:i,isSpace:/^\d+$/.test(n.kfid)?0:1,showEditLine:n.showEditLine}),t?(s.find("tr:first").before(r),s.find(".t1-index").each(function(e,t){t.innerHTML=e+1}),s.css({zIndex:1})):(n.dataAuthor.push(e),s.append(r))},delUser:function(e,t){var n=this,r,i,s,o=n.dataAuthor,u;t=t||$(n.ruleParent+" [data-email="+e+"]");if(n.selectUserLength==1){$.fn.tips("权限设置里,至少要有一名用户管理空间权限",0,0,"tipscenter");return}r=t.parents("table"),delete n.dataAuthorTag[e],--n.selectUserLength,t.remove(),n.dataAuthor=_.without(o,_.findWhere(o,{email:e})),r.find(".t1-index").each(function(e,t){t.innerHTML=e+1})},findTr:function(e){e=$.trim(e);if(!e)return;var t,n=this,r,i,s,o,u;t=n.dataTeam,r=new RegExp(e),i=t.filter(function(e,t){var n=e.name||"";if(n.match(r))return!0}),s=_.pluck(i,"email"),u=$(n.ruleParent+" .rpart .wraptable"),$(n.ruleParent+" .rpart tr").removeClass("on"),$.each(s,function(e,t){o=$(n.ruleParent+" .rpart tr[data-email="+t+"]"),e==0&&u.animate({scrollTop:o.offset().top-u.offset().top},200),o.addClass("on")})},stopShare:function(){var e=this;e.modal.setRule.hide(),e.modal.del.show()},resetRule:function(e){var t=this,n=$(e.target),r,i,s,o,u;o=n.parents("tr");if(o.hasClass("disable"))return;s=o.attr("data-rtype"),i=o.attr("data-email"),s==3?o.find("input").prop("checked",!1):t.delUser(i,o)},recoveData:function(){var e=this.lastRuleData;if(!e)return;var t=_.filter(e,function(e,t){return e.rtype=="1"}),n=_.filter(e,function(e,t){return e.rtype=="3"});this.renderUsers(t),this.renderTeams(n)},getFormData:function(){var e=this,t,n,r,i=[];return t=$(this.ruleParent),n=t.find("tr"),n.each(function(e,t){var n=$(t).find("input"),s,o,u,a={},f,l,c,h,p;o=t.getAttribute("data-email"),u=t.getAttribute("data-rtype"),c=t.getAttribute("data-name"),h=t.getAttribute("data-isqadmin")-0,p=t.getAttribute("data-isrewrite")-0;for(var d=0,v=n.length;d<v;d++)f=n[d],l=f.getAttribute("value"),r=!!f.checked-0,a[l]=r;typeof a.isedit=="undefined"&&(a.isedit=0),$.extend(a,{name:c,realname:c,email:o,rtype:u,isqadmin:h,isrewrite:p}),i.push(a)}),i},submitForm:function(e){var t=this,n,r=[],i=["isadmin","isupload","isdownload","isedit","isview","isdel"];n=t.getFormData(),$.each(n,function(e,t){var n=[],s;for(var o=0,u=i.length;o<u;o++)n.push(t[i[o]]);s={email:t.email,chmod:n.join(""),rtype:t.rtype},r.push(s)});var s=JSON.stringify(r),o=$(this.ruleParent).find(".inherit").prop("checked");$.post($.urlMap.setteamrule,{fid:t.kfid,rules:s,isherit:o?1:0},function(e){if(e.errno){$.fn.tips(e.errmsg);return}t.modal.setRule.hide()})},hideTips:function(){var e=this;$(this.ruleParent).find(".tips").stop().css({opacity:0});return},showTips:function(e){var t=this;$(this.ruleParent).find(".tips").html(e).stop().css({opacity:1})},initModalSet:function(){var e=this;e.modal.setRule=new $.fn.Modal({id:e.ruleParent,layid:"#lay6",closeButton:".close4",stopClickClose:1,data:{showEditLine:e.showEditLine},tpl:e.settpl,okButton:"#ok4",events:{"click .switch li":e.switchTypes,"mouseenter table tr":e.mouseon,"mouseleave table tr":e.mouseout,"click #ok5":function(){e.submitForm(this.$parent)},"click .stopShare":function(){e.stopShare()},"click td .greybox":function(){e.noInherit()},"click #startSearch":function(t){var n=this.$parent.find(".spart")[0].value;e.findTr(n)},"keyup .spart":function(t){var n=$(t.currentTarget)[0].value;t.keyCode==13&&this.lastValue==n&&e.findTr(n),this.lastValue=n},"click .delrule":function(t){var n=$(t.target).parents("tr");if(n.hasClass("disable"))return;e.resetRule(t),e.noInherit()},"click .addall":function(t){var n=$(t.currentTarget),r;if(e.isAddAll)return;e.isAddAll=1,e.addUser({email:"allusers",rtype:1,isview:1,isdownload:0,isedit:0,isadmin:0,isrewrite:1,isqadmin:0,realname:"所有人"},1),e.noInherit()},"click .inherit":function(t){var n=$(t.currentTarget),r;r=!!n.attr("checked")-0,r?(e.lastRuleData=e.getFormData(),e.initSetData(this.$parent,1),e.showTips("您更改的权限将丢失，恢复到与父目录一致")):(e.recoveData(),e.showTips("目录权限已修改，不再与父目录一致"))}},beforeShow:function(){var t=e.kfid;t.match(/^t/)?this.$parent.find(".bottom").hide():this.$parent.find(".bottom").show(),$(e.ruleParent).find(".inherit").prop("checked",!1),delete e.lastRuleData,e.hideTips()},showCallBack:function(){var t=this.$parent;e.initSetData(t)}});if(this.initPoptipsFlag)return;this.initPoptipsFlag=1,$.fn.poptips({parent:e.ruleParent,selector:".ttip",cls:"tpop",top:2})},initSetData:function(e,t){var n=this;n.dataAuthor=[],n.dataAuthorTag={},n.isAddAll=0,n.initUsers(e),n.initUserSearch(e),n.showTeams(e,t),n.showUsers(e,t)},initModalDel:function(){var e=this;e.modal.del=new $.fn.Modal({id:"#wrapdel5",closeButton:".close2",okButton:".bbutton",layid:"#lean_overlay7",stopClickClose:1,cls:"wrapdel",data:{tips:"恢复默认后将继承父级目录权限,<br/>您将失去本目录下更改的权限设置.<br/>确认恢复到父目录一致?"},css:{zIndex:15e3},okCallBack:function(t){e.lockShow=1,e.reqStopShare()},closeCallBack:function(){e.lockShow||e.modal.setRule.show()},callScope:e,tpl:e.confirmtpl})},reqStopShare:function(){var e=this,t=e.kfid;$.get($.urlMap.stopteamrule,{source:"team",fid:t,_:(new Date).getTime()},function(t){if(t.errno)return;e.modal.del.hide(),e.lockShow=0})},initModalNew:function(){var e=this;e.modal.addNew=new $.fn.Modal({id:"#wrapaddnew",layid:"#layteam",closeButton:".close4",okButton:"#ok4",stopClickClose:1,cls:"wrapaddnew",events:{"keyup #spacename":function(t){var n=$(t.currentTarget)[0].value,r=$(t.target);t.keyCode==13&&this.lastValue==n&&e.addSpace(n,r),this.lastValue=n}},okCallBack:function(t){var n,r=this.$parent.find("#spacename"),i=this;n=r.val(),e.addSpace(n,r)},showCallBack:function(){var e=this.$parent.find("#spacename");e.val("新建空间").select().focus()},tpl:e.newtpl})},addSpace:function(e,t){var n=this;if(!$.trim(e)){$.fn.tips("输入不能为空!"),t.focus();return}$.post($.urlMap.addqzone,{teamname:e},function(e){if(e.errno){$.fn.tips(e.errmsg);return}$.fn.tips("创建成功！",1),n.goTeamPage({fid:"t"+e.result.qzoneId}),Backbone.Events.trigger("UpdateTreeTeam"),n.modal.addNew.hide()})},reloadTreeTeam:function(e){var t=this;if(!t.tree||t.options.route!="team")return;this.$el.find(".wrap-tree").css({opacity:0}),t.tree.updateTree({getData:this.getTreeData(e)})},getTreeData:function(e){var t=this;return function(e){return function(){var e=$.Deferred(),n;return n={source:"team",vfid:t.fid||0},n._=(new Date).getTime(),$.get($.urlMap.tturl,n,function(t){if(parseInt(t.errno))return;e.resolve(t.result)}),e.promise()}}(e)},extendInit:function(e){var t=this;t.$el.find(".headnav").html(e.name).show(),e.auths.allow_addqzone&&t.$el.find(".addnew").css({display:"block"}),this.showEditLine=parseInt(e.isedit),Backbone.Events.on("UpdateTreeTeam",function(e){t.reloadTreeTeam(e)}),Backbone.Events.on("LoadTeamCTree",function(e){}),this.initModalNew(),this.initModalDel(),this.initModalSet()},getMenuConfig:function(){var e=this,t={insertBefore:1,dbclicktime:200,dropParent:"#wrapall",getData:function(t){var n=this,r=e.rightOps,i=t.target.getAttribute("data-fid"),s=$.Deferred(),o=$.urlMap.menulist;return $.get(o,{fid:i,_:(new Date).getTime()},function(e){var t=[],i;if(e.errno)return;e=e.result.menulist;for(var o in e)i=e[o],i&&t.push(r[o]);n.lists=t,s.resolve()}),s.promise()},reqOnAdd:function(e,t){var n=$.Deferred(),r;return r=$.urlMap.addurl,$.post(r,{dirname:t,source:"team",parentid:e,sid:0},function(e){var t=0;e.errno&&($.fn.tips(e.errmsg),t=1),n.resolve(e)}),n.promise()},reqOnRemove:function(e){var t=$.Deferred(),n;return n=$.urlMap.tmoveurl,/^\d+$/.test(e)&&(n=$.urlMap.removeurl),$.post(n,{fids:e},function(e){var n=0;e.errno&&($.fn.tips(e.errmsg),n=1),t.resolve(n)}),t.promise()},reqOnRename:function(e,t){var n=$.Deferred(),r;return r=$.urlMap.tseturl,/^\d+$/.test(e)&&(r=$.urlMap.renameFile),$.post(r,{fid:e,name:t,source:"team"},function(e){var t=0;e.errno&&($.fn.tips(e.errmsg),t=1),n.resolve(t)}),n.promise()},onClick:function(t,n){var r=n.attr("data-fid");e.kfid=r;var i=0;if(t=="down"){var s="team";window.open($.urlMap.downFile+"?fid="+r+"&source="+s+"&sid="+i+"&t="+(new Date).getTime());return}if(t=="setrule"){var o=n.html();e.modal.setRule.$parent.find(".nav").html("权限设置（"+o+"）"),e.modal.setRule.show()}}};return t},initTree:function(){var e=this,t,n,r;r=this.getMenuConfig();if(this.hasInit)return;this.hasInit=1,this.tree=$.BaseTree2.getExample({parentId:"treeteam",insertBefore:1,getData:function(t){var n=$.Deferred(),r;return r={source:"team",vfid:e.fid||0},r._=(new Date).getTime(),$.get($.urlMap.tturl,r,function(e){if(parseInt(e.errno))return;n.resolve(e.result)}),n.promise()},getCData:function(e){var t=$.Deferred(),n;return n={source:"team",fid:e},n._=(new Date).getTime(),$.get($.urlMap.tturl,n,function(e){if(parseInt(e.errno))return;t.resolve(e.result)}),t.promise()},alias:function(e){var t={id:"fid",text:"dirname",hasChild:"havechild",child:"child",allowmenu:"allowmenu"};return t[e]||e},litpl:e.treespantpl,depth:2,open:!0,callbacks:{onBuildTree:function(){e.setDomAsCurrent()},onClick:function(t){var n=t.target.getAttribute("data-fid"),r=$($.ldom.getParentByTag(t.target,"li"));r.hasClass("depth1")&&this.closeAll(r);var i={};i.fid=n,e.goTeamPage(i)},onDeleteChild:function(t){var n=t.fid,r;t.fid||(r=t.child||[],r=r[0],n=r.fid),e.goTeamPage({fid:n}),e.setDomAsCurrent(n),$.fn.tips("删除成功",1)},onFinishInput:function(){e.$el[0].scrollLeft=0}},plugins:[{type:"menu2",options:r}]})}});return u});